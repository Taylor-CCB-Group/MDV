(self.webpackChunkciview2=self.webpackChunkciview2||[]).push([[746],{2806:(t,s,i)=>{"use strict";i.r(s),i.d(s,{acceptTiffCache:()=>d,default:()=>m});var e=i(5579),a=i(4677),n=i(5923),o=i(5451);function l(t){const s=Array.isArray(t)?t[0]:t,{shape:i,labels:e}=s,a=function(t){const{x:s,y:i,z:e}=t?.meta?.physicalSizes??{};if(s?.size&&i?.size&&e?.size){const t=Math.min(e.size,s.size,i.size),a=[s.size/t,i.size/t,e.size/t];return(new o.Z).scale(a)}return(new o.Z).identity()}(s);return[[0,a[0]*i[e.indexOf("x")]],[0,a[5]*i[e.indexOf("y")]],[0,a[10]*i[e.indexOf("z")]]]}var c=i(8569),h=i(8503);const r=new Map;function d(t){console.log("accepting tiff cache"),t.forEach(((t,s)=>{r.set(s,t)}))}const m=class{constructor(t,s,i){console.log("new VivViewer",s),this.canvas=t,this.height=this.canvas.height,this.width=this.canvas.width,this.config=s,this.hasRequestedDefaultChannelStats=!1,this.initClip(),function(t){if(r.has(t))return r.get(t);const s=(0,e.$L)(t);return r.set(t,s),s}(s.url).then((t=>{this.tiff=t,this._setUp(t,i)}))}setSize(t,s,i){this.height=s,this.width=t;const e=this.getViewState(i.x_scale,i.y_scale,i.offset);this.canvas.width=t,this.canvas.height=s,this.canvas.style.width=t,this.canvas.style.height=s,this.deck.setProps({height:s,width:t,viewState:e})}setPanZoom(t,s,i){const e=this.getViewState(s,i,t);this.deck.setProps({viewState:e})}getViewState(t,s,i){if(this.config.use3d)return;const a=Math.log2(s),n=Math.log2(t);let o=1/t*this.native_x/2;o-=i[0];let l=1/s*this.native_y/2;return l+=this.native_y-i[1],{height:this.native_y,width:this.native_x,id:e.ys,target:[o,l,0],zoom:[n,a]}}setChannel(t){const s=this.mainVivLayer.props,i=s.selections.findIndex((s=>s.id===t.id));s.colors[i]=(0,a.$W)(t.color),s.contrastLimits[i]=t.contrastLimits,s.channelsVisible[i]=t.channelsVisible,t.domains&&(s.domains[i]=t.domains),this.layers=[...this.layers],this.deck.setProps({layers:this.layers})}removeChannel(t){const s=this.mainVivLayer.props,i=s.selections.findIndex((s=>s.id===t.id));s.colors.splice(i,1),s.selections.splice(i,1),s.contrastLimits.splice(i,1),s.channelsVisible.splice(i,1),s.domains.splice(i,1),this.createLayers(s),this.deck.setProps({layers:[this.layers]})}async addChannel(t){const s=this.mainVivLayer.props;s.channelsVisible.push(!0),t.color=t.color||"#ff00ff";const i={z:0,t:0,c:t.index},e=await this.getDefaultChannelValues([{index:0,sel:i}]);return t.contrastLimits=e[0].stats.contrastLimits,t.domains=e[0].stats.domain,t.channelsVisible=!0,s.colors.push((0,a.$W)(t.color)),s.contrastLimits.push(t.contrastLimits),s.domains.push(t.domains),t.id=(0,h.zO)(),s.selections.push({...i,id:t.id}),this.createLayers(s),this.deck.setProps({layers:[this.layers]}),t.name=this.channels[t.index].Name,t}getAllChannels(){return this.channels}getSelectedChannels(){const{props:t}=this.mainVivLayer,s=t.selections.map((t=>this.channels[t.c].Name)),i=t.colors.map(a.fc);return s.map(((s,e)=>({name:s,index:t.selections[e].c,id:t.selections[e].id,color:i[e],contrastLimits:t.contrastLimits[e].slice(0),channelsVisible:t.channelsVisible[e],domains:t.domains[e]})))}recenterCamera(){if(!this.config.use3d)return;console.log("recenter");const{SizeX:t,SizeY:s,SizeZ:i}=this.tiff.metadata.Pixels,e={target:[t/2,s/2,i/2],zoom:1,rotationX:0,rotationOrbit:0+.01*Math.random()};this.volViewState=e,this.deck.setProps({initialViewState:e})}_createLayers3D(){const t=this.tiff,{SizeX:s,SizeY:i,SizeZ:a,Channels:n}=t.metadata.Pixels,o="3d_"+e.ys,l=t.data,h=n.length,r=t.data[0].dtype,{domains:d,contrastLimits:m,selections:p,colors:f,channelsVisible:u}=this.newVivProps??(this.mainVivLayer?this.mainVivLayer.props:function(t){const s=new Array(t).fill([0,1e3]),i=s,e=new Array(t).fill().map(((t,s)=>({c:s,t:0,z:0,_id:s}))),a=function(t){return 1==t?[[255,255,255]]:new Array(t).fill([0,0,0]).map(((s,i)=>{const e=i/t;return[Math.floor(255*e),Math.floor(255*(1-e)),0]}))}(t);return{domains:s,contrastLimits:i,selections:e,colors:a,channelsVisible:new Array(t).fill(!0)}}(h));this.newVivProps=null,this.hasRequestedDefaultChannelStats||(this.hasRequestedDefaultChannelStats=!0,this.defaultDomains=d,this.defaultContrastLimits=m.slice(0),async function(t,s=[{c:0,t:0}]){const i=await Promise.all(s.map((s=>async function(t,s={c:0,t:0}){const i=t[t.length-1],{shape:a,labels:n}=i,o=a[n.indexOf("z")]>>t.length-1,l=await i.getRaster({selection:{...s,z:0}}),c=await i.getRaster({selection:{...s,z:Math.floor(o/2)}}),h=await i.getRaster({selection:{...s,z:Math.max(0,o-1)}}),r=(0,e.mx)(l.data),d=(0,e.mx)(c.data),m=(0,e.mx)(h.data);return{domain:[Math.min(r.domain[0],d.domain[0],m.domain[0]),Math.max(r.domain[1],d.domain[1],m.domain[1])],contrastLimits:[Math.min(r.contrastLimits[0],d.contrastLimits[0],m.contrastLimits[0]),Math.max(r.contrastLimits[1],d.contrastLimits[1],m.contrastLimits[1])]}}(t,s))));return{domains:i.map((t=>t.contrastLimits)),contrastLimits:i.map((t=>t.contrastLimits))}}(l,p).then((t=>{this.defaultDomains=t.domains,this.defaultContrastLimits=t.contrastLimits.slice(0),this.newVivProps={...this.mainVivLayer.props,...t},this._updateProps()})));const y=this.getXSlice(),g=this.getYSlice(),w=this.getZSlice(),L={id:o,loader:l,dtype:r,resolution:l.length-1,channelsVisible:u,contrastLimits:m,domains:d,selections:p,colors:f,xSlice:y,ySlice:g,zSlice:w},v=this.detailView.getLayers({props:L,viewStates:[this.volViewState]});this.layers=v,this.mainVivLayer=v[0],this.config.scatterData&&v.push(new c.Z({data:this.config.scatterData,radiusScale:1,billboard:!0,getFillColor:this.config.getScatterFillColor}))}initClip(){this.clipX=[0,1],this.clipY=[0,1],this.clipZ=[0,1]}setClipX(t,s){this.clipX=[t,s],this._updateProps()}setClipY(t,s){this.clipY=[t,s],this._updateProps()}setClipZ(t,s){this.clipZ=[t,s],this._updateProps()}getXSlice(){const{SizeX:t}=this.tiff.metadata.Pixels,[s,i]=this.clipX,e=l(this.loader)[0][1];return[s*e,i*e]}getYSlice(){const{SizeY:t}=this.tiff.metadata.Pixels,[s,i]=this.clipY,e=l(this.loader)[1][1];return[s*e,i*e]}getZSlice(){const{SizeZ:t}=this.tiff.metadata.Pixels,[s,i]=this.clipZ,e=l(this.loader)[2][1];return[s*e,i*e]}_updateProps(){this.createLayers(),this.deck.setProps({layers:this.layers})}_parseChannels(t){const s={selections:[],colors:[],channelsVisible:[],contrastLimits:[],domains:[]};for(let i of t){s.selections.push({z:0,t:0,c:this.channels.findIndex((t=>t.Name===i.name))});let t=i.color;t=t?"string"==typeof i.color?(0,a.$W)(t):t:[255,0,0],s.colors.push(t),s.channelsVisible.push(null==i.visible||i.visible),s.contrastLimits.push(i.contrastLimits||null),s.domains.push(i.domains||null)}return s}getSelectedChannelsNice(){const t=this.layers[0].props;return t.selections.map(((s,i)=>({name:this.channels[s.c].Name,color:t.colors[i],visible:t.channelsVisible[i],contrastLimits:t.contrastLimits[i],domains:t.domains[i]})))}_setUp(t,s){this.native_x=t.metadata.Pixels.SizeX,this.native_y=t.metadata.Pixels.SizeY;const{use3d:i}=this.config;this.extensions=[new e.Gl],this.channels=t.metadata.Pixels.Channels,this.loader=t.data,this.transparentColor=[255,255,255,0];const a=this.getViewState(s.x_scale,s.y_scale,s.offset);if(i){const{SizeX:s,SizeY:i,SizeZ:a}=t.metadata.Pixels,n=[s/2,i/2,a/2];this.volViewState={zoom:1,target:n},this.detailView=new e.Cw({id:e.ys,useFixedAxis:!1,target:n,extensions:[new e.lC.AdditiveBlendExtension]})}else this.detailView=new e.O6({id:e.ys,height:this.native_y,width:this.native_x});const o=this.volViewState;let{image_properties:l}=this.config;const c=this.detailView.getDeckGlView();if(this.config.channels&&(l=this._parseChannels(this.config.channels)),l?.selections)for(let t of l.selections)t.id=(0,h.zO)();const r=[];for(let t=0;t<l.contrastLimits.length;t++)l.contrastLimits[t]&&l.domains[t]||r.push({index:t,sel:l.selections[t]});this.getDefaultChannelValues(r).then((t=>{for(let s of t)l.contrastLimits[s.index]=s.stats.contrastLimits,l.domains[s.index]=s.stats.domain;this.createLayers(l),this.deck=new n.Z({canvas:this.canvas,layers:[this.layers],views:[c],viewState:a,width:this.width,height:this.height,useDevicePixels:!1,initialViewState:o,controller:i})}))}async getDefaultChannelValues(t){return await Promise.all(t.map((async t=>{const s=await this.loader[this.loader.length-1].getRaster({selection:t.sel});return{index:t.index,stats:(0,e.mx)(s.data)}})))}createLayers(t){if(this.config.use3d)return void this._createLayers3D();const s={id:e.ys},i={loader:this.loader,contrastLimits:t.contrastLimits.slice(0),domains:t.domains.slice(0),colors:t.colors.slice(0),channelsVisible:t.channelsVisible.slice(0),selections:t.selections.slice(0),extensions:this.extensions,transparentColor:this.transparentColor};this.defaultDomains||(this.defaultDomains=i.contrastLimits),this.defaultContrastLimits||(this.defaultContrastLimits=this.defaultDomains.slice(0)),this.layers=this.detailView.getLayers({viewStates:s,props:i}),this.mainVivLayer=this.layers[0]}}},479:()=>{},2249:()=>{},3752:()=>{},3640:()=>{},2630:()=>{},4351:()=>{}}]);