(()=>{function t(t,e){let n=t.length-1;n=0===n?1:n;let a=t.reduce(((t,n)=>t+Math.pow(n-e,2)),0);return Math.sqrt(a/n)}onmessage=function(e){const n=e.data[3],a=new("text16"==n.datatype||"multitext"==n.datatype?Uint16Array:Uint8Array)(e.data[2]),r=new Uint8Array(e.data[0]),o=new Uint8Array(e.data[1]);let l=null;l="sankey"===n.method?function(t,e,n,a,r){const o=r.values.length,l=r.values2.length,s=n.length,i=new Array(o),u=r.values.map(((t,e)=>"A"+e)),c=r.values2.map(((t,e)=>"B"+e));for(let t=0;t<o;t++)i[t]=new Array(l).fill(0);const f=[];let d=0;for(let r=0;r<s;r++)0!==e[r]&&e[r]!==t[r]||(i[n[r]][a[r]]++,d++);const h=new Set,m=new Set,g=Math.round(d/300);for(let t=0;t<o;t++)for(let e=0;e<l;e++){const n=i[t][e];0!==n&&(h.add(u[t]),m.add(c[e]),f.push({source:u[t],target:c[e],value:n<g?g:n,trueValue:n}))}const y=Math.min(h.size,m.size),p=Array.from(h).map((t=>({id:t,ind:t.substring(1),param:0}))),A=Array.from(m).map((t=>({id:t,ind:t.substring(1),param:1})));return{links:f,nodes:p.concat(A),minNodes:y}}(r,o,a,new Uint8Array(e.data[4]),n):"venn"===n.method?function(t,e,n,a){const r=performance.now(),o=n.length/a.stringLength,l=new Map,s=a.stringLength;for(let a=0;a<o;a++){if(0!==e[a]&&e[a]!==t[a])continue;const r=a*s;let o=n.slice(r,r+s).toString();const i=l.get(o);i?l.set(o,i+1):l.set(o,1)}const i=[];for(const[t,e]of l.entries(l)){const n=t.split(",").map((t=>a.values[t])).filter((t=>void 0!==t));i.push({sets:n,size:e})}return console.log("calc ven : "+(performance.now()-r)),i}(r,o,a,n):"proportion"===n.method?function(e,n,a,r,o){const l=o.values.length,s=o.values2.length,i=o.cats?new Uint8Array(o.cats):null,u=a.length,c=new Array(l),f=o.diviser?o.diviser:new Array(l);for(let t=0;t<l;t++)c[t]=new Array(s).fill(0),f[t]=new Array(s).fill(0);const d=o.category;for(let t=0;t<u;t++)if(f[a[t]][r[t]]++,0===n[t]){if(i&&i[t]!==d)continue;c[a[t]][r[t]]++}let h=0,m=1e7;for(let e=0;e<f.length;e++){const n=f[e],a=c[e],r=[],l=[];let s=0,i=0,u=1e7;for(let t=0;t<n.length;t++){if(0===n[t])continue;const c=o.denominators?a[t]/o.denominators[t]:a[t]/n[t]*100;r.push([c,e,t,Math.floor(6*Math.random())]),l.push(c),s+=c,i=Math.max(i,c),u=Math.min(u,c)}r.av=s/r.length,r.std=t(l,r.av),r.max=i,r.min=u,c[e]=r,h=Math.max(h,i),m=Math.min(m,u)}return c.max=h,c.min=m,c}(0,o,a,new Uint8Array(e.data[4]),n):"stacked"===n.method?function(t,e,n,a,r){const o=n.length,l=Array.from(r.values,((t,e)=>({id:e,values:Array.from(r.values2,((t,e)=>({id:e,count:0}))),total:0})));for(let r=0;r<o;r++)0!==e[r]&&e[r]!==t[r]||(l[n[r]].values[a[r]].count++,l[n[r]].total++);for(let t of l){let e=0,n=0;for(let a of t.values){const r=0===t.total?0:a.count/t.total;a.pos=e,a.per=r,a.perpos=n,e+=a.count,n+=r}}return l}(r,o,a,new Uint8Array(e.data[4]),n):"double_cat"===n.method?function(t,e,n,a,r){const o=n.length,l="multitext"===r.datatype2,s=Array.from(r.values,((t,e)=>Array.from(r.values2,((t,n)=>({i1:e,i2:n,c:0})))));for(let i=0;i<o;i++)if(0===e[i]||e[i]===t[i])if(l)for(let t=i*r.stringLength2;t<r.stringLength2&&65535!==n[t];t++)s[n[i]][a[t]].c++;else s[n[i]][a[i]].c++;return s}(r,o,a,"multitext"===n.datatype2?new Uint16Array(e.data(4)):new Uint8Array(e.data(4)),n):function(t,e,n,a){const r="multitext"===a.datatype?n.length/a.stringLength:n.length,o=new Array(a.values.length).fill(0);if("multitext"===a.datatype){const l=a.stringLength;for(let a=0;a<r;a++){if(0!==e[a]&&e[a]!==t[a])continue;const r=a*l;for(let t=r;t<r+l&&65535!==n[t];t++)o[n[t]]++}}else for(let a=0;a<r;a++)0!==e[a]&&e[a]!==t[a]||o[n[a]]++;return o}(r,o,a,n),postMessage(l)}})();