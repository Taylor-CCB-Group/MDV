{"version":3,"file":"VivViewerMDV-VF3MTiZC.js","sources":["../../../../src/utilities/VivUtils.js","../../../../src/webgl/VivViewerMDV.js"],"sourcesContent":["import { getChannelStats } from \"@hms-dbmi/viv\";\nimport { Matrix4 } from '@math.gl/core';\n\n\n\n/** copied (not quite verbatim) from avivator utils */\nexport async function getSingleSelectioStats3D(loader, selection = { c: 0, t: 0 }) {\n    const lowResSource = loader[loader.length - 1];\n    const { shape, labels } = lowResSource;\n    const sizeZ = shape[labels.indexOf('z')] >> (loader.length - 1);\n    const raster0 = await lowResSource.getRaster({\n        selection: { ...selection, z: 0 }\n    });\n    const rasterMid = await lowResSource.getRaster({\n        selection: { ...selection, z: Math.floor(sizeZ / 2) }\n    });\n    const rasterTop = await lowResSource.getRaster({\n        selection: { ...selection, z: Math.max(0, sizeZ - 1) }\n    });\n    const stats0 = getChannelStats(raster0.data);\n    const statsMid = getChannelStats(rasterMid.data);\n    const statsTop = getChannelStats(rasterTop.data);\n    return {\n        domain: [\n            Math.min(stats0.domain[0], statsMid.domain[0], statsTop.domain[0]),\n            Math.max(stats0.domain[1], statsMid.domain[1], statsTop.domain[1])\n        ],\n        contrastLimits: [\n            Math.min(\n                stats0.contrastLimits[0],\n                statsMid.contrastLimits[0],\n                statsTop.contrastLimits[0]\n            ),\n            Math.max(\n                stats0.contrastLimits[1],\n                statsMid.contrastLimits[1],\n                statsTop.contrastLimits[1]\n            )\n        ]\n    };\n}\n\nexport async function getMultiSelectionStats(loader, selections = [{ c: 0, t: 0 }]) {\n    const stats = await Promise.all(\n        selections.map(selection => getSingleSelectioStats3D(loader, selection))\n    );\n    const domains = stats.map(stat => stat.contrastLimits);\n    const contrastLimits = stats.map(stat => stat.contrastLimits);\n    return { domains, contrastLimits };\n}\n\nexport function getDefaultSelectionStats(n) {\n    const domains = new Array(n).fill([0, 1000]);\n    const contrastLimits = domains;\n    //nb, not clear that adding _id here is necessarily ideal, seems to be working for now\n    //key for keeping track of multiple 'channels' with selections on the same 'c'.\n    const selections = new Array(n).fill().map((_, i) => {return {c: i, t: 0, z: 0, _id: i}});\n    const colors = getDefaultChannelColors(n);\n    const channelsVisible = new Array(n).fill(true);\n    return { domains, contrastLimits, selections, colors, channelsVisible };\n}\n\nexport function getDefaultChannelColors(n) {\n    if (n == 1) return [[255, 255, 255]];\n    else return new Array(n).fill([0, 0, 0]).map((_, i) => {\n        //TODO: non-shit algorithm / use a nice palette.\n        const a = i / (n);\n        return [Math.floor(a * 255), Math.floor((1 - a) * 255), 0];\n    });\n}\n\n\n/**\n * Get physical size scaling Matrix4\n * @param {Object} loader PixelSource\n */\nexport function getPhysicalSizeScalingMatrix(loader) {\n    const { x, y, z } = loader?.meta?.physicalSizes ?? {};\n    if (x?.size && y?.size && z?.size) {\n        const min = Math.min(z.size, x.size, y.size);\n        const ratio = [x.size / min, y.size / min, z.size / min];\n        return new Matrix4().scale(ratio);\n    }\n    return new Matrix4().identity();\n}\n\nexport function getBoundingCube(loader) {\n    const source = Array.isArray(loader) ? loader[0] : loader;\n    const { shape, labels } = source;\n    const physicalSizeScalingMatrix = getPhysicalSizeScalingMatrix(source);\n    const xSlice = [0, physicalSizeScalingMatrix[0] * shape[labels.indexOf('x')]];\n    const ySlice = [0, physicalSizeScalingMatrix[5] * shape[labels.indexOf('y')]];\n    const zSlice = [\n        0,\n        physicalSizeScalingMatrix[10] * shape[labels.indexOf('z')]\n    ];\n    return [xSlice, ySlice, zSlice];\n}\n","import {\n  loadOmeTiff,\n  DetailView,\n  VolumeView,\n  ColorPaletteExtension,\n  ColorPalette3DExtensions,\n  DETAIL_VIEW_ID,\n  getChannelStats\n} from '@hms-dbmi/viv';\n\nimport {hexToRGB, RGBToHex} from \"../datastore/DataStore.js\";\nimport {Deck} from '@deck.gl/core';\nimport { getMultiSelectionStats, getDefaultSelectionStats, getBoundingCube } from '../utilities/VivUtils.js';\nimport { ScatterplotLayer } from 'deck.gl';\nimport { getRandomString, NPOT } from '../utilities/Utilities.js';\n\nconst tiffs = new Map();\nexport function acceptTiffCache(oldTiffs) {\n  console.log('accepting tiff cache');\n  oldTiffs.forEach((tiff, key) => {\n    tiffs.set(key, tiff);\n  });\n}\nfunction getTiff(url) {\n  if (tiffs.has(url)) {\n    return tiffs.get(url);\n  }\n  const tiff = loadOmeTiff(url);\n  tiffs.set(url, tiff);\n  return tiff;\n}\n// if (module.hot) {\n//   module.hot.accept(newModule => {\n//     newModule.acceptTiffCache(tiffs);\n//   });\n// }\n\n\nclass VivViewerMDV {\n  constructor(canvas, config, initialView){\n    console.log('new VivViewerMDV', config);\n    this.canvas = canvas;\n    this.height = this.canvas.height;\n    this.width = this.canvas.width;\n    this.config = config;\n    this.hasRequestedDefaultChannelStats = false;\n    this.initClip();\n   \n    getTiff(config.url).then(loader => {\n      this.tiff = loader;\n      this._setUp(loader, initialView);\n    });\n  }\n\n  setSize(x,y,conf){\n    this.height=y;\n    this.width=x;\n\n    const { x_scale, y_scale, offset } = conf;\n    const v = this.getViewState(x_scale, y_scale, offset);\n    this.canvas.width = x;\n    this.canvas.height = y;\n    this.canvas.style.width = x;\n    this.canvas.style.height = y;\n    this.deck.setProps({\n      height:y,\n      width:x,\n      viewState:v\n    })\n  }\n\n\n  setPanZoom(offset,x_scale,y_scale){  \n    const v= this.getViewState(x_scale,y_scale,offset);\n    this.deck.setProps({\n      viewState:v\n    })\n  }\n\n  getViewState(x_scale,y_scale,offset){\n    // when rendering 3d, we want viewState to be undefined so it can use initialViewState & internal camera control\n    if (this.config.use3d) return undefined;\n    const hzoom = Math.log2(y_scale);\n    const wzoom = Math.log2(x_scale);\n    let xpos = ((1/x_scale)*(this.native_x))/2;\n    xpos-= offset[0];\n    let ypos = ((1/y_scale)*(this.native_y))/2;\n    ypos+=this.native_y-offset[1];\n    return {\n      height:this.native_y,\n      width:this.native_x,\n      id:DETAIL_VIEW_ID,\n      target:[xpos,ypos,0],\n      zoom:[wzoom,hzoom]\n    }\n  }\n\n  setChannel(channel){\n    const channels = this.mainVivLayer.props;\n    const i = channels.selections.findIndex(x=>x.id===channel.id);\n\n    channels.colors[i]=hexToRGB(channel.color);\n    channels.contrastLimits[i]=channel.contrastLimits;\n    channels.channelsVisible[i]= channel.channelsVisible;\n    if (channel.domains) channels.domains[i] = channel.domains;\n    this.layers=[...this.layers];\n    this.deck.setProps({\n      layers: this.layers\n    })\n  }\n\n  removeChannel(channel){\n    const chs = this.mainVivLayer.props;\n    const i = chs.selections.findIndex(sel=>sel.id===channel.id);\n    chs.colors.splice(i,1);\n    chs.selections.splice(i,1);\n    chs.contrastLimits.splice(i,1);\n    chs.channelsVisible.splice(i,1);\n    chs.domains.splice(i,1);\n    this.createLayers(chs);\n    this.deck.setProps({\n      layers:[this.layers]\n    });\n\n  }\n\n  async addChannel(channel){\n    const chs = this.mainVivLayer.props;\n    chs.channelsVisible.push(true);\n    channel.color= channel.color || \"#ff00ff\";\n    // pjt consider using helpers (now effectively doing this indirectly).\n    /// --> channel.contrastLimit was always undefined anway\n    // channel.contrastLimits = channel.contrastLimit || [20,100];\n    //if new channels are addded there are no default values -need to be calculated?\n    const sel ={z:0,t:0,c:channel.index};\n    const data = await this.getDefaultChannelValues([{index:0,sel}]);\n\n    channel.contrastLimits = data[0].stats.contrastLimits;//this.defaultContrastLimits[channel.index].slice(0);\n    channel.domains = data[0].stats.domain;//this.defaultDomains[channel.index].slice(0);\n    channel.channelsVisible=true;\n    chs.colors.push(hexToRGB(channel.color));\n    chs.contrastLimits.push(channel.contrastLimits);\n    chs.domains.push(channel.domains);\n    channel.id = getRandomString();\n    chs.selections.push({...sel,id:channel.id});\n    \n    this.createLayers(chs);\n    this.deck.setProps({\n      layers:[this.layers],\n    });\n    \n\n    channel.name=this.channels[channel.index].Name;\n    //channel._id = chs.selections[chs.selections.length-1]._id;\n    return channel;\n\n  }\n\n  /** equivalent to VivScatterPlot... */\n  getAllChannels() {\n    return this.channels;\n  }\n  getSelectedChannels() {\n    const {props} = this.mainVivLayer;\n    const names = props.selections.map(x => this.channels[x.c].Name);\n    const colors = props.colors.map(RGBToHex);\n    return names.map((name, i) => {\n      return {\n        name,\n        index: props.selections[i].c,\n        id: props.selections[i].id,\n        color: colors[i],\n        contrastLimits: props.contrastLimits[i].slice(0),\n        channelsVisible: props.channelsVisible[i],\n        domains: props.domains[i]\n      }\n    });\n  }\n\n  recenterCamera() {\n    if (!this.config.use3d) return;\n    console.log('recenter');\n    const {SizeX, SizeY, SizeZ} = this.tiff.metadata.Pixels;\n    const target = [SizeX / 2, SizeY / 2, SizeZ / 2];\n    const initialViewState = {\n      target,\n      zoom: 1,\n      rotationX: 0,\n      rotationOrbit: 0 + Math.random() * 0.01\n    }\n    this.volViewState = initialViewState;\n    this.deck.setProps({\n      initialViewState\n    });\n  }\n\n  _createLayers3D() {\n    const tiff = this.tiff;\n    //most of this can move into createLayers()\n    const {SizeX, SizeY, SizeZ, Channels: channels} = tiff.metadata.Pixels;\n    const target = [SizeX/2, SizeY/2, SizeZ/2];\n    const id = '3d_' + DETAIL_VIEW_ID;\n    const loader = tiff.data;\n    const n = channels.length;\n    // this is wrong in cases where non-default set of channels is used.\n    // const selections = channels.map((_, i) => {return {c: i, t: 0, z: 0}});\n    const dtype = tiff.data[0].dtype;\n    const { domains, contrastLimits, selections, colors, channelsVisible } = this.newVivProps \n      ?? (this.mainVivLayer ? this.mainVivLayer.props : getDefaultSelectionStats(n));\n    this.newVivProps = null;\n    if (!this.hasRequestedDefaultChannelStats) {\n      this.hasRequestedDefaultChannelStats = true;\n      this.defaultDomains = domains;\n      this.defaultContrastLimits = contrastLimits.slice(0);\n      getMultiSelectionStats(loader, selections).then((v) => {\n        this.defaultDomains = v.domains;\n        this.defaultContrastLimits = v.contrastLimits.slice(0);\n        this.newVivProps = { ...this.mainVivLayer.props, ...v };\n        this._updateProps();\n      });\n    }\n    const xSlice = this.getXSlice();\n    const ySlice = this.getYSlice();\n    const zSlice = this.getZSlice();\n    const resolution = loader.length - 1; // this should change...\n    const props = {\n      id,\n      loader,\n      dtype,\n      resolution,\n      channelsVisible,\n      contrastLimits,\n      domains,\n      selections,\n      colors,\n      xSlice, ySlice, zSlice\n    };\n    const volumeView = this.detailView;\n    // could we setProps here instead when the layer already exists? no, don't think so - readonly.\n    const layers = volumeView.getLayers({\n      props, viewStates: [this.volViewState]\n    });\n    this.layers = layers;\n    this.mainVivLayer = layers[0];\n    if (this.config.scatterData) {\n      // alert('scatter!');\n      layers.push(new ScatterplotLayer({\n        data: this.config.scatterData,//.slice(0), //do not want to clone / slice here... but mutating data doesn't work otherwise\n        radiusScale: 1,\n        billboard: true,\n        getFillColor: this.config.getScatterFillColor\n        // getFillColor: (d) => d.color || [100, 100, 100]\n      }));\n    }\n  };\n\n  initClip() {\n    this.clipX = [0, 1];\n    this.clipY = [0, 1];\n    this.clipZ = [0, 1];\n  }\n  // so much boilerplate...\n  setClipX(min, max) {\n    this.clipX = [min, max];\n    this._updateProps();\n  }\n  setClipY(min, max) {\n    this.clipY = [min, max];\n    this._updateProps();\n  }\n  setClipZ(min, max) {\n    this.clipZ = [min, max];\n    this._updateProps();\n  }\n  getXSlice() {\n    const {SizeX} = this.tiff.metadata.Pixels;\n    const [min, max] = this.clipX;\n    // const v = NPOT(SizeX);\n    const v = getBoundingCube(this.loader)[0][1];\n    return [min*v, max*v];\n  }\n  getYSlice() {\n    const {SizeY} = this.tiff.metadata.Pixels;\n    const [min, max] = this.clipY;\n    // const v = NPOT(SizeY);\n    const v = getBoundingCube(this.loader)[1][1];\n    return [min*v, max*v];\n  }\n  getZSlice() {\n    const {SizeZ} = this.tiff.metadata.Pixels;\n    const [min, max] = this.clipZ;\n    // const v = NPOT(SizeZ);\n    const v = getBoundingCube(this.loader)[2][1];\n    return [min*v, max*v];\n  }\n  _updateProps() {\n    this.createLayers();\n    this.deck.setProps({layers: this.layers})\n  }\n\n    //parses the config into internal data structure\n    //adding any missing values as necessary\n    _parseChannels(conf){\n        const nconf={\n            selections:[],\n            colors:[],\n            channelsVisible:[],\n            contrastLimits:[],\n            domains:[]\n        }\n        for (let item of conf){\n            const name = item.name || item.Name;\n            const c = this.channels.findIndex(x => x.Name===name);\n            if (c === -1) {\n              //TODO throw error, or show warning in UI\n              console.warn('channel not found', item);\n              console.warn('available channel Names', this.channels.map(c => c.Name));\n              continue;\n            }\n            nconf.selections.push({z:0, t:0, c});\n            let color = item.color;\n            // todo nicer default colors\n            color = color ? typeof item.color === \"string\" ? hexToRGB(color) : color : [255,0,0];\n            nconf.colors.push(color);\n            nconf.channelsVisible.push(item.visible==undefined?true:item.visible);\n            nconf.contrastLimits.push(item.contrastLimits || null);\n            nconf.domains.push(item.domains || null);\n        }\n        return nconf;\n    }\n\n    //get the channels in a nice format\n    getSelectedChannelsNice(){\n        const k = this.layers[0].props;\n        return k.selections.map((x,i)=>{\n            return {\n                name:this.channels[x.c].Name,\n                color:k.colors[i],\n                visible:k.channelsVisible[i],\n                contrastLimits:k.contrastLimits[i],\n                domains:k.domains[i]\n            }\n        })\n    }\n\n  _setUp(loader, iv){\n    this.native_x= loader.metadata.Pixels.SizeX;\n    this.native_y= loader.metadata.Pixels.SizeY;\n    const {use3d} = this.config;\n    \n    this.extensions = [new ColorPaletteExtension()];\n    this.channels = loader.metadata.Pixels.Channels;\n    this.loader = loader.data;\n    this.transparentColor = [255,255,255]; //luma.gl warning 'Uniform size should be multiples of 3'\n    const baseViewState = this.getViewState(iv.x_scale,iv.y_scale,iv.offset);\n    \n    if (use3d) {\n      // this._setUpVolumeView(loader);\n      const { SizeX, SizeY, SizeZ } = loader.metadata.Pixels;\n      const target = [SizeX / 2, SizeY / 2, SizeZ / 2];\n      this.volViewState = {\n        zoom: 1, target\n      };\n      this.detailView = new VolumeView({\n        id: DETAIL_VIEW_ID,\n        useFixedAxis: false,\n        target,\n        extensions: [new ColorPalette3DExtensions.AdditiveBlendExtension()],\n      });\n    } else {\n      this.detailView = new DetailView({\n        id: DETAIL_VIEW_ID,\n        height:this.native_y,\n        width:this.native_x\n      });\n    }\n    const initialViewState = this.volViewState;\n    let {image_properties} = this.config;\n\n    const deckGLView =this.detailView.getDeckGlView();\n    //new more readable config\n    if (this.config.channels){\n      image_properties = this._parseChannels(this.config.channels)\n    }\n    if (image_properties?.selections) for (let s of image_properties.selections){\n      s.id=getRandomString();\n    }\n    //check if there are any channels without contrast limits and get default values\n    const contrastLimitsToGet = [];\n    for (let n=0;n<image_properties.contrastLimits.length;n++){\n        if (image_properties.contrastLimits[n] && image_properties.domains[n]){\n            continue;\n        }\n        contrastLimitsToGet.push({index:n,sel:image_properties.selections[n]})\n    }\n    //get the default values and continue the set up\n    this.getDefaultChannelValues(contrastLimitsToGet).then(data=>{\n        for (let d of data){\n            image_properties.contrastLimits[d.index]=d.stats.contrastLimits;\n            image_properties.domains[d.index]=d.stats.domain;\n        }\n        this.createLayers(image_properties);\n        this.deck=new Deck({\n          canvas: this.canvas,\n          layers: [this.layers],\n          views: [deckGLView],\n          viewState: baseViewState,\n          width: this.width,\n          height: this.height,\n          useDevicePixels: false, //why false?\n          initialViewState,\n          controller: use3d\n        });\n\n    })\n    }\n\n    //would be better to sample data that's loaded - but can't find\n    //a way of doing this. Also domainLimits seem way too large and for\n    //very low signals contrast limits are way too high\n    async getDefaultChannelValues(selections){\n      const loader = this.loader[this.loader.length - 1]; // lowest resolution\n      return await Promise.all(selections.map(async (s) => {\n        const data = await loader.getRaster({selection:s.sel});\n        return {index:s.index,stats:getChannelStats(data.data)};\n      }))\n    }\n\n    createLayers(info){\n        if (this.config.use3d) {\n            this._createLayers3D();\n            return;\n        }\n        const viewStates=  {id: DETAIL_VIEW_ID}\n\n        //domains may not be the same as contrast limits -  again need way of calculating\n        //temp default values\n        \n\n        const layerConfig = {\n            loader:this.loader,\n            contrastLimits:info.contrastLimits.slice(0),\n            domains:info.domains.slice(0),\n            colors:info.colors.slice(0),\n            channelsVisible:info.channelsVisible.slice(0),\n            selections:info.selections.slice(0),\n            extensions:this.extensions,\n            transparentColor:this.transparentColor\n        };\n        if (!this.defaultDomains) this.defaultDomains = layerConfig.contrastLimits; //PJT somewhat tested\n        if (!this.defaultContrastLimits) this.defaultContrastLimits = this.defaultDomains.slice(0);\n        this.layers = this.detailView.getLayers({\n            viewStates,\n            props:layerConfig\n        });\n        this.mainVivLayer = this.layers[0];\n    }\n}\n\nexport default VivViewerMDV;"],"names":["getSingleSelectioStats3D","loader","selection","lowResSource","shape","labels","sizeZ","raster0","rasterMid","rasterTop","stats0","getChannelStats","statsMid","statsTop","getMultiSelectionStats","selections","stats","domains","stat","contrastLimits","getDefaultSelectionStats","n","_","i","colors","getDefaultChannelColors","channelsVisible","a","getPhysicalSizeScalingMatrix","x","y","z","_a","min","ratio","Matrix4","getBoundingCube","source","physicalSizeScalingMatrix","xSlice","ySlice","zSlice","tiffs","acceptTiffCache","oldTiffs","tiff","key","getTiff","url","loadOmeTiff","VivViewerMDV","canvas","config","initialView","conf","x_scale","y_scale","offset","v","hzoom","wzoom","xpos","ypos","DETAIL_VIEW_ID","channel","channels","hexToRGB","chs","sel","data","getRandomString","props","names","RGBToHex","name","SizeX","SizeY","SizeZ","initialViewState","id","dtype","resolution","layers","ScatterplotLayer","max","nconf","item","c","color","k","iv","use3d","ColorPaletteExtension","baseViewState","target","VolumeView","ColorPalette3DExtensions","DetailView","image_properties","deckGLView","s","contrastLimitsToGet","d","Deck","info","viewStates","layerConfig"],"mappings":"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"}